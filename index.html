<html>
	<!-- By Spartacus Rex -->
	<!-- Re-skinned by Elias Nemr -->
	<!-- Graphics & design by Pete Howell -->
	<!-- 13/11/2020 -->
<head>
	<!--   The MINIMA MiFi Javascript Library -->
	<script type="text/javascript" src="minima.js"></script>
	<script type="text/javascript" src="decimal.js"></script>
	<!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
	<!--  STYLE -->
	<link rel="stylesheet" type="text/css" href="future.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<title>FUTURE CASH</title>
</head>

<body>

	
	<script type="text/javascript">
		// init date picker
		document.addEventListener('DOMContentLoaded', function() {
			var elems = document.querySelectorAll('.datepicker');
			let options = {
				minDate: new Date()
			};
			var instances = M.Datepicker.init(elems, options);
			let options2 = {};
			var elems = document.querySelectorAll('.timepicker');
			var instances = M.Timepicker.init(elems, options2);
		  });
		//Global Variables - used Script IDE..
		var timescript  = "LET owner = PREVSTATE ( 0 ) LET time = PREVSTATE ( 1 ) RETURN SIGNEDBY ( owner ) AND @BLKNUM GTE time";
 		var timeaddress = "";
 			
		function setTime(){
			//Set the right time
			document.getElementById("blocktime").innerHTML = "Blocktime: "+Minima.block;	
		}
		
		function setBalance(){
			//Use Util function to get Balance..
			document.getElementById("yourbalance").innerHTML = "Balance: "+Minima.util.getBalance("0x00");
		}
		
		function newKey(){
			Minima.cmd("keys new", function(json){
				document.getElementById("myaddress").innerHTML = ""+json.response.key.publickey;
			});
		}
		
		function showPage(page){
			if(page == 0 ){
				document.getElementById("introBtn").classList.add("active");
				document.getElementById("myFutureBtn").classList.remove("active");
				document.getElementById("sendCashBtn").classList.remove("active");

				document.getElementById("intro").classList.remove("hide");
				document.getElementById("sendcash").classList.add("hide");
				document.getElementById("mycash").classList.add("hide");
			
			}else if(page == 1 ){
				document.getElementById("sendCashBtn").classList.add("active");
				document.getElementById("introBtn").classList.remove("active");
				document.getElementById("myFutureBtn").classList.remove("active");

				document.getElementById("intro").classList.add("hide");
				document.getElementById("sendcash").classList.remove("hide");
				document.getElementById("mycash").classList.add("hide");
				
			}else if(page == 2 ){
				document.getElementById("myFutureBtn").classList.add("active");
				document.getElementById("introBtn").classList.remove("active");
				document.getElementById("sendCashBtn").classList.remove("active");

				document.getElementById("intro").classList.add("hide");
				document.getElementById("sendcash").classList.add("hide");
				document.getElementById("mycash").classList.remove("hide");
				
			}
		}
	
		function sendFunds(){
			amount = document.getElementById("amount").value.trim();
			date   = document.getElementById("futuredate").value.trim();

			time   = document.getElementById("futuretime").value.trim();


			key    = document.getElementById("futurekey").value.trim();
			
			if(amount == "" || time=="" || key =="" ){
				var elems = document.querySelectorAll('.modal');
				let options = {
					opacity: 0.7,
					dismissible: true,
					onOpenStart: function(){
						$('#modalSendFunds h4').text("Can't accept empty or invalid entries!");
						$('#modalSendFunds p').text("");
						$('#yesBtn').addClass("hide");
					},
				};
				var instances = M.Modal.init(elems, options);
				return;
			}

			let confirmed = false;
			var elems = document.querySelectorAll('.modal');
			let options = {
				opacity: 0.7,
				dismissible: true,
				onOpenStart: function(){
					$('#modalSendFunds h4').html("You are about to send money to the <b>Future!</b>");
					$('#modalSendFunds p').text("are you sure?");
					$('#yesBtn').removeClass("hide");

					$('#yesBtn').on('click', function(){
						confirmed = true;
					});
				},
				onCloseEnd: function() {
					if(confirmed) {
						//Clear it..
						document.getElementById("amount").value = "";
						document.getElementById("futuretime").value = "";
						document.getElementById("futurekey").value = "";
						
						//Create a random txn id..
						var txnid = Math.floor(Math.random()*1000000000);
						
						//Construct Transaction..
						var txncreator = 
							"txncreate "+txnid+";"+
							"txnstate "+txnid+" 0 "+key+";"+
							"txnstate "+txnid+" 1 "+time+";"+
							"txnauto "+txnid+" "+amount+" "+timeaddress+";"+
							"txnpost "+txnid+";"+
							"txndelete "+txnid+";";
					
						//Post it..
						Minima.cmd( txncreator , function(resp){
							Minima.util.checkAllResponses(resp);
						});
					}
				}
			};
			var instances = M.Modal.init(elems, options);
			
			
		}
		
		function cashFunction(){
			Minima.cmd("coins relevant address:"+timeaddress , function(json){

				let cashtable =
							'<table id="futuretable" class="highlight">'+
								'<thead>'+
									'<tr>'+
										'<th>AMOUNT</th>'+
										'<th>TIME</th>'+
										'<th>COLLECT</th>'+
									'</tr>'+
								'</thead'+
								'<tbody>';
				
				//get any of these coins that have the time address
				var coinlen = json.response.coins.length;
				for(i=0;i<coinlen;i++){
					var coinproof = json.response.coins[i].data;
					
					var keycoin    = Minima.util.getStateVariable(coinproof.prevstate,0);
					var timecoin   = parseInt(Minima.util.getStateVariable(coinproof.prevstate,1), 10);
					var amountcoin = coinproof.coin.amount;
					
					var collectstring = "";
					if(timecoin <= Minima.block){
						collectstring="<button id=\""+coinproof.coin.coinid+"\" onclick='collectCoin(\""+coinproof.coin.coinid+"\",\""+keycoin+"\",\""+amountcoin+"\");' class='collect btn-flat waves-effect waves-light'>COLLECT</button>";
					}else{
						var diff = timecoin - Minima.block;
						collectstring = "Ready in "+diff+"..";
					}
					
					if(coinproof.coin.address == timeaddress){
						cashtable += 
						"<tr><td class=futurecash>"+coinproof.coin.amount+"</td>"+
							"<td class=futurecash>"+Minima.util.getStateVariable(coinproof.prevstate,1)+"</td>"+
							"<td id='futurecashbtn' class=futurecash>"+collectstring+"</td>"+
						"</tr>";	
					}
				}
				
				if(coinlen == 0){
					cashtable += "<tr> <td colspan=3 style='text-align:center;'> <br>No money yet! </td> </tr>";
				}
				
				cashtable += "</tbody></table>";

				//And set it..
				document.getElementById("futuremoney").innerHTML = cashtable;
			});
		}
		
		function collectCoin(coinid, key, cashamount){
			//Disable the button..
			document.getElementById(coinid).disabled = 'true';
			
			//Get a new address and send these funds to that..
			Minima.cmd("newaddress", function(json){
				var newaddress = json.response.address.miniaddress;
				
				//Now build the collect transaction and send..
				//Create a random txn id..
				var txnid = Math.floor(Math.random()*1000000000);
				
				//Construct Transaction..
				var txncreator = 
					"txncreate "+txnid+";"+
					"txninput "+txnid+" "+coinid+";"+
					"txnoutput "+txnid+" "+cashamount+" "+newaddress+" 0x00;"+
					"txnsign "+txnid+" "+key+";"+
					"txnpost "+txnid+";"+
					"txndelete "+txnid+";";
				
				//Post it..
				Minima.cmd( txncreator , function(resp){
					if(Minima.util.checkAllResponses(resp)){
						
						var elems = document.querySelectorAll('.modal');
						let options = {
							opacity: 0.7,
							dismissible: true,
							onOpenStart: function() {
								$('#modalSendFunds h4').text("Funds Collected!");
								$('#modalSendFunds p').text("Check your balance!");
								$('#yesBtn').addClass("hide");
							},
						};
						var instances = M.Modal.init(elems, options);	
					}
			    });	
			});
		}
		
		//Wait for the page to load..
		window.addEventListener("load", function(){
			
			//Initialise MiFi
			Minima.init(function(msg){
				//Deal with each message type
		 		if(msg.event == "connected"){
			 		setTime();
			 		setBalance();
			 		
			 		// Tell Minima about the timescript! Now you can spend it when required 
			 		// Minima listens for any scripts with your PUBLIC KEYS in the STATE or PREVSTATE and 
			 		// tracks those outputs automagically..
			 		Minima.cmd("extrascript \""+timescript+"\"", function(resp){
					 	//Set the time address
				 		timeaddress = resp.response.address.hexaddress;
				 		
				 		//Run it once..
				 		cashFunction();
			 		});
			 				
			 	}else if(msg.event == "newblock"){
		 			setTime();
		 			cashFunction();
		 			
		 		}else if(msg.event == "newbalance"){
		 			setBalance();
		 		}
			});
			
			//Show Intro
			showPage(0);
		});
		
	</script>
	
	<div id="menu" class="container center-align">
		<div id="b-title-wrap" class="z-depth-1 card">
			<div class="card-title">
				<h4>
					Future<span>Cash ></span>
					<span id="demo">Demo</span>
				</h4>
			</div>
		</div>

		<div id="menuBtn-wrap" class="z-depth-0 card">
			<div class="card-content">
				<ul class="collection with-header">
					<li class="collection-header">
						<div onclick="showPage(0)" id="introBtn" class="btn menuBtn active">Intro</div>
						<div onclick="showPage(1)" id="sendCashBtn" class="btn menuBtn">Send Cash</div>
						<div onclick="showPage(2)" id="myFutureBtn" class="btn menuBtn">My Future</div>
					</li>
				</ul>
				<!-- Intro -->
				<div id="intro">
					<h5>Send cash to the future!</h5>
					<p>Ask whoever you are sending cash to, to use this MiniDAPP to generate their key Or better still - send YOURSELF some cash.. do your future self a favour! The <b>best</b> way to safe-guard your money is not to spend it.. NOW.</p>

					<p id="myaddress">no key generated yet!</p>

					<div id="genBtn-wrap" class="row">
						<div class="col s6">
							<div onclick="newKey();" class="btn genBtn">Generate your key </div>
						</div>
						<div class="valign-wrapper col s6">
							<p><b>Only use the key once!</b></p>
						</div>
					</div>
					
				</div>
				<!-- Send Cash -->
				<div id="sendcash" class="hide">
					<ul class="collection">
						<div class="input-field col s3">
							<input size="40" class="datepicker" id="futuredate">
						</div>
						<div class="input-field col s3">
							<input size="40" class="timepicker" id="futuretime">
						</div>
						<div class="input-field">
							<input size="40" type="number" id="amount">
							<label for="amount">Amount</label>
						</div>
						<div class="input-field">
							<input size="40" type="text" id="futurekey">
							<label for="futurekey">Key</label>
						</div>
						<li class="collection-item input-field">
							<div onclick="sendFunds()" data-target="modalSendFunds" class="btn sendBtn modal-trigger">Send Funds</div>
						</li>
					</ul>

				</div>
				<!-- My Future -->
				<div id="mycash" class="hide">
					<div id="futuremoney">
						NO MONEY YET
					</div>
				</div>

				<div class="card-action">
					<div class="row">
						<div class="col s6">
							<div class="baldiv" id="yourbalance">...</div>
						</div>
						<div class="col s6">
							<div class="timediv" id="blocktime">...</div>
						</div>
					</div>
				</div>

			</div>
		</div>


		<!-- Modal -->
		<div id="modalSendFunds" class="modal">
			<div class="modal-content">
			  <h4>You are about to send money to the <b>Future!</b></h4>
			  <p>Are you sure?</p>
			</div>
			<div class="modal-footer">
			  <a href="#!" class="modal-close waves-effect waves-green btn-flat">Dismiss</a>
			  <a id="yesBtn" href="#!" class="modal-close waves-effect waves-green btn-flat">Yes</a>
			</div>
		  </div>

	</div>

	<!-- Compiled and minified JavaScript -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
    
</html>