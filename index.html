<html>
	<!-- By Spartacus Rex -->
	<!-- Re-skinned by Elias Nemr -->
	<!-- Graphics & design by Pete Howell -->
	<!-- 13/11/2020 -->
<head>
	  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
	<!--   The MINIMA MiFi Javascript Library -->
	<script type="text/javascript" src="minima.js"></script>
	<script type="text/javascript" src="decimal.js"></script>
	<!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="css/materialize.css">
	<!--  STYLE -->
	<link rel="stylesheet" type="text/css" href="future.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<title>FUTURE CASH</title>
</head>

<body>

	<script type="text/javascript">

		// init date picker
		document.addEventListener('DOMContentLoaded', function() {
			
			// instantiate date-picker
			var elems = document.querySelectorAll('.datepicker');
			let options = {
				minDate: new Date()
			};
			var instances = M.Datepicker.init(elems, options);
			// instantiate time-picker
			let options2 = {};
			var elems2 = document.querySelectorAll('.timepicker');
			var instances2 = M.Timepicker.init(elems2, options2);
			
		  });

		//Global Variables - used Script IDE..
		var timescript  = "LET owner = PREVSTATE ( 0 ) LET time = PREVSTATE ( 1 ) RETURN SIGNEDBY ( owner ) AND @BLKNUM GTE time";
		 var timeaddress = "";
		 
		function showBlock(block) {
			M.toast({html: "Ready at block - "+block, classes:"ready"});
		}
		 
		function setTime(){
			//Set the right time
			document.getElementById("blocktime").innerHTML = "Block time: "+Minima.block;	
		}
		
		function setBalance(){
			//Use Util function to get Balance..
			document.getElementById("yourbalance").innerHTML = "Balance: "+Minima.util.getBalance("0x00");
		}
		
		function newKey(){
			Minima.cmd("keys new", function(json){
				document.getElementById("futurekey").value = ""+json.response.key.publickey;
			});
		}
		
		function showPage(page){
			if(page == 0 ){
				document.getElementById("introBtn").classList.add("active");
				document.getElementById("myFutureBtn").classList.remove("active");
				document.getElementById("sendCashBtn").classList.remove("active");

				document.getElementById("intro").classList.remove("hide");
				document.getElementById("sendcash").classList.add("hide");
				document.getElementById("mycash").classList.add("hide");
			
			}else if(page == 1 ){
				document.getElementById("sendCashBtn").classList.add("active");
				document.getElementById("introBtn").classList.remove("active");
				document.getElementById("myFutureBtn").classList.remove("active");

				document.getElementById("intro").classList.add("hide");
				document.getElementById("sendcash").classList.remove("hide");
				document.getElementById("mycash").classList.add("hide");
				
			}else if(page == 2 ){
				document.getElementById("myFutureBtn").classList.add("active");
				document.getElementById("introBtn").classList.remove("active");
				document.getElementById("sendCashBtn").classList.remove("active");

				document.getElementById("intro").classList.add("hide");
				document.getElementById("sendcash").classList.add("hide");
				document.getElementById("mycash").classList.remove("hide");
				
			}
		}
	
		function sendFunds(){
			amount = document.getElementById("amount").value.trim();
			date   = document.getElementById("futuredate").value.trim();

			time   = document.getElementById("futuretime").value.trim();


			key    = document.getElementById("futurekey").value.trim();
			
			// add the date to time chosen by user...
			if(date=="") {
				return M.toast({html: "Empty input fields are not allowed!"});
			}
			date+=" "+time;
			// create it
			let calculateDate = new Date(date);
			// get the date in milliseconds
			let ms = calculateDate.getTime();
			// get today's date and time
			let today = new Date();
			// get it as ms
			let msToday = today.getTime();
			// get difference
			let difference = ms - msToday;
			// block time == 20000 milliseconds/20 seconds
			let BLOCK_TIME = 20000;
			// get the amount of blocks needed till time
			let blockDifference = Math.round(difference/BLOCK_TIME);
			// current block
			let block = Minima.block + blockDifference;

			if(amount == "" || time=="" || key =="" || date=="" ){
				var elems = document.querySelectorAll('.modal');
				let options = {
					opacity: 0.7,
					dismissible: true,
					onOpenStart: function(){
						$('#modalSendFunds h4').text("Can't accept empty or invalid entries!");
						$('#modalSendFunds p').text("");
						$('#yesBtn').addClass("hide");
					},
				};
				var instances = M.Modal.init(elems, options);
				return;
			}

			let confirmed = false;
			var elems = document.querySelectorAll('.modal');
			let options = {
				opacity: 0.7,
				dismissible: true,
				onOpenStart: function(){
					$('#modalSendFunds h4').html("You are about to send money to the <b>Future!</b>");
					$('#modalSendFunds p').text("are you sure?");
					$('#yesBtn').removeClass("hide");

					$('#yesBtn').on('click', function(){
						confirmed = true;
					});
				},
				onCloseEnd: function() {
					if(confirmed) {
						//Clear it..
						document.getElementById("amount").value = "";
						document.getElementById("futuretime").value = "";
						document.getElementById("futuredate").value = "";
						document.getElementById("futurekey").value = "";
						
						//Create a random txn id..
						var txnid = Math.floor(Math.random()*1000000000);
						
						//Construct Transaction..
						var txncreator = 
							"txncreate "+txnid+";"+
							"txnstate "+txnid+" 0 "+key+";"+
							"txnstate "+txnid+" 1 "+block+";"+
							"txnstate "+txnid+" 2 "+ms+";"+
							"txnauto "+txnid+" "+amount+" "+timeaddress+";"+
							"txnpost "+txnid+";"+
							"txndelete "+txnid+";";
					
						//Post it..
						Minima.cmd( txncreator , function(resp){
							Minima.util.checkAllResponses(resp);
						});
					}
				}
			};
			var instances = M.Modal.init(elems, options);
			
			
		}
		
		function cashFunction(){
			Minima.cmd("coins relevant address:"+timeaddress , function(json){

				let cashtable =
							'<table id="futuretable" class="centered">'+
								'<thead>'+
									'<tr>'+
										'<th id="th-amnt">Amount</th>'+
										'<th id="th-time">Time</th>'+
										'<th id="th-collect">Collect</th>'+
									'</tr>'+
								'</thead>'+
								'<tbody>';
				
				//get any of these coins that have the time address
				var coinlen = json.response.coins.length;
				for(i=0;i<coinlen;i++){
					var coinproof = json.response.coins[i].data;
					
					var keycoin    = Minima.util.getStateVariable(coinproof.prevstate,0);
					var timecoin   = parseInt(Minima.util.getStateVariable(coinproof.prevstate,1), 10);
					var datecoin   = parseInt(Minima.util.getStateVariable(coinproof.prevstate, 2), 10);
					var date = "";
					date = new Date(datecoin);
					var amountcoin = coinproof.coin.amount;
					
					var collectstring = "";
					if(timecoin <= Minima.block){
						collectstring="<button id=\""+coinproof.coin.coinid+"\" onclick='collectCoin(\""+coinproof.coin.coinid+"\",\""+keycoin+"\",\""+amountcoin+"\");' class='collect btn-flat btn-small waves-effect waves-light'>COLLECT</button>";
					}else{
						var diff = timecoin - Minima.block;
						collectstring = "Ready in "+diff+"..";

						// calculate progress
						let percent = (Minima.block/diff * 100);
						
						collectstring = '<div onclick="showBlock('+timecoin+')" class="progress">'+
											'<div class="determinate" style="width: '+percent+'">'+
										'</div>';
					}

					// format date
					const dateTimeFormat = new Intl.DateTimeFormat('en', {
						year: '2-digit',
						month: 'short',
						day: 'numeric',
						hour: 'numeric',
						minute: 'numeric',
					  });
					date = dateTimeFormat.format(date);
					date = moment(date).format("MMM DD, YY - HH:mm")
					
					if(coinproof.coin.address == timeaddress){
						cashtable +=
									'<tr>'+
										'<td class="futurecash"><div class="wrap">'+coinproof.coin.amount+'</div></td>'+
										'<td class="futurecash"><div class="wrap">'+date+'</div></td>'+
										'<td class="futurecash" id="futurecashbtn"><div class="wrap">'+collectstring+'</div></td>'+
									'</tr>';
					}
				}
				
				if(coinlen == 0){
					cashtable += 
								'<tr>'+
									'<td colspan="3" style="text-align: center;"> <br>No money yet! </td>'+
								'</tr>';
				}
				
				cashtable += "</tbody></table>";

				//And set it..
				document.getElementById("futuremoney").innerHTML = cashtable;
			});
		}
		
		function collectCoin(coinid, key, cashamount){
			//Disable the button..
			document.getElementById(coinid).disabled = 'true';
			
			//Get a new address and send these funds to that..
			Minima.cmd("newaddress", function(json){
				var newaddress = json.response.address.miniaddress;
				
				//Now build the collect transaction and send..
				//Create a random txn id..
				var txnid = Math.floor(Math.random()*1000000000);
				
				//Construct Transaction..
				var txncreator = 
					"txncreate "+txnid+";"+
					"txninput "+txnid+" "+coinid+";"+
					"txnoutput "+txnid+" "+cashamount+" "+newaddress+" 0x00;"+
					"txnsign "+txnid+" "+key+";"+
					"txnpost "+txnid+";"+
					"txndelete "+txnid+";";
				
				//Post it..
				Minima.cmd( txncreator , function(resp){
					if(Minima.util.checkAllResponses(resp)){

						M.toast({html: "Collected "+cashamount+" FutureCash!", classes:"success"});
						
					}
			    });	
			});
		}
		
		//Wait for the page to load..
		window.addEventListener("load", function(){
			
			//Initialise MiFi
			Minima.init(function(msg){
				//Deal with each message type
		 		if(msg.event == "connected"){
			 		setTime();
			 		setBalance();
			 		
			 		// Tell Minima about the timescript! Now you can spend it when required 
			 		// Minima listens for any scripts with your PUBLIC KEYS in the STATE or PREVSTATE and 
			 		// tracks those outputs automagically..
			 		Minima.cmd("extrascript \""+timescript+"\"", function(resp){
					 	//Set the time address
				 		timeaddress = resp.response.address.hexaddress;
				 		
				 		//Run it once..
				 		cashFunction();
			 		});
			 				
			 	}else if(msg.event == "newblock"){
		 			setTime();
		 			cashFunction();
		 			
		 		}else if(msg.event == "newbalance"){
		 			setBalance();
		 		}else if(msg.event == "miningstart") {
					M.toast({html: "Mining started...", classes:"miningstarted"});
				}else if(msg.event == "miningstop") {
					M.toast({html: "Mining stopped...", classes:"miningstop"});
				}
			});
			
			//Show Intro
			showPage(0);
		});
		
	</script>
	

	<div id="menu" class="container center-align">
		<div class="menu-header">
			<div id="b-title-wrap" class="z-depth-0">
				<h4> Future<span>Cash ></span> <span id="demo">Demo</span>
					<img id="icon" src="assets/MINIMA_ORANGE.svg">
				</h4>
			</div>

			<div id="buttons">
				<div onclick="showPage(0)" id="introBtn" class="btn-flat menuBtn active">About</div>
				<div onclick="showPage(1)" id="sendCashBtn" class="btn-flat menuBtn">Send Cash</div>
				<div onclick="showPage(2)" id="myFutureBtn" class="btn-flat menuBtn">My Future</div>
			</div>
		</div>
		
		<div id="menu-content" class="z-depth-0 card">
			<div class="card-content">
				<!-- Intro -->
				<div id="intro">
					<h5>Safeguard your money with FutureCash.</h5>
					<p style="padding-right: 3.5%;">Look after your money by not spending it <span style="font-family: manrope-bold;">NOW!</span><br>  So do your future-self a favour - generate a key and send yourself some FutureCash.<br> You can look after money for others, too!  Get them to send you their generated FutureCash key, then use that key to safeguard their future.</p>
				</div>
				<!-- Send Cash -->
				<div id="sendcash" class="hide">
					<div class="row">

					</div>
					<div class="row">
						<div class="col s3">
							<h6 style="margin-top: 0">Date & Time:</h6>
						</div>
						<div class="col s4">
							<input size="40" class="datepicker" id="futuredate">
						</div>
						<div class="col s5">
							<input size="40" type="text" class="timepicker" id="futuretime">
						</div>
					</div>
					<div class="row">
						<div class="col s3">
							<h6>Amount:</h6>
						</div>
						<div class="col s9">
							<input size="40" type="number" id="amount">
						</div>
					</div>
					<div class="row">
						<div class="col s3">
							<h6>Key:</h6>
						</div>
						<div class="col s9">
							<input size="40" type="text" id="futurekey">
						</div>
					</div>
					<div class="row">
						<div class="col push-m3 m6 push-s3 s9">
							<div onclick="sendFunds()" data-target="modalSendFunds" class="btn-flat sendBtn modal-trigger left">Send Funds</div>
						</div>
						<div class="col push-m1 m5 hide-on-small-and-down">
							<div onclick="newKey();" class="btn-flat genBtn2">Generate key</div>
						</div>
					</div>
					<div class="row">
						<div class="col s3"></div>

						<div style="margin: 0 !important" class="col pull-s1 s9 hide-on-med-and-up">
							<div onclick="newKey();" class="btn-flat genBtn">Generate key</div>
						</div>
					</div>
				</div>
				<!-- My Future -->
				<div id="mycash" class="hide">
					<div id="futuremoney">
						NO MONEY YET
					</div>
				</div>
			</div>
		</div>

		<div class="menu-footer">
			<div class="row">
				<div style="padding: 0;" class="col s6">
					<div class="baldiv" id="yourbalance">...</div>
				</div>
				<div style="padding: 0;" class="col s6">
					<div class="timediv" id="blocktime">...</div>
				</div>
			</div>
		</div>


		<!-- Modal -->
		<div id="modalSendFunds" class="modal">
			<div class="modal-content">
			  <h4>You are about to send money to the <b>Future!</b></h4>
			  <p>Are you sure?</p>
			</div>
			<div class="modal-footer">
			  <a href="#!" class="modal-close waves-effect waves-green btn-flat">Dismiss</a>
			  <a id="yesBtn" href="#!" class="modal-close waves-effect waves-green btn-flat">Yes</a>
			</div>
		  </div>

	</div>

	<!-- Compiled and minified JavaScript -->
	<script src="js/materialize.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>
</body>
    
</html>